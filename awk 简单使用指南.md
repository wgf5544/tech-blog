# awk 简单使用指南

### 基本用法：

```
awk '{print $0}' demo.txt
```

或者管道符方式：

```
netstat | awk '{print $0}'
```

其中单引号中被大括号括着的就是 awk 语句，注意，其只能被单引号包含。

### 内建变量：

| 变量     | 描述                                                         |
| -------- | ------------------------------------------------------------ |
| $0       | 当前记录（这个变量中存放着整个行的内容）                     |
| $1~$n    | 当前记录的第n个字段，字段间由FS分隔                          |
| FS       | 输入字段分隔符 默认是空格或Tab                               |
| NF       | 当前记录中的字段个数，就是有多少列                           |
| NR       | 已经读出的记录数，就是行号，从1开始，如果有多个文件话，这个值也是不断累加中。 |
| FNR      | 当前记录数，与NR不同的是，这个值会是各个文件自己的行号       |
| RS       | 输入的记录分隔符， 默认为换行符                              |
| OFS      | 输出字段分隔符， 默认也是空格                                |
| ORS      | 输出的记录分隔符，默认为换行符                               |
| FILENAME | 当前输入文件的名字                                           |

### 常用

输出第一列和第四列：

```
netstat | awk '{print $1, $4}'
```

变量`NF`表示当前行有多少个字段，因此`$NF`就代表最后一个字段。

```
netstat | awk '{print $NF}'
```

`$(NF-1)`代表倒数第二个字段。

```
netstat | awk '{print $1, $(NF-1)}'
```

第三列的值为 0 `&&` 第 6 列的值为 LISTEN，其中的 `==` 为比较运算符。其他比较运算符：!=, >, <, >=, <=

```
netstat | awk '$3==0 && $6=="LISTEN"'
```

第三列大于 0 的所有行：

```
netstat | awk '$3>0 {print $0}'
```

`-F` 的意思是指定分隔符，如果要指定多个分隔符，可以这样来：`awk -F '[;:]'`

```
cat /etc/passwd | awk  -F: '{print $1,$3,$6}' OFS="\t"
```

 `~` 表示模式开始。`/ /` 中是模式。下面的例子是一个正则表达式的匹配模式：

```
netstat | awk '$6 ~ /WAIT/ || NR==1 {print NR,$4,$5,$6}' OFS="\t"

```

我们可以使用 `/FIN|TIME/` 来匹配 FIN 或者 TIME :

```
netstat | awk '$6 ~ /FIN|TIME/ || NR==1 {print NR,$4,$5,$6}' OFS="\t"

```

再来看看模式取反的例子：

```
netstat | awk '$6 !~ /WAIT/ || NR==1 {print NR,$4,$5,$6}' OFS="\t"

```

awk 拆分文件很简单，使用重定向就好了。下面这个例子，是按第 6 列分隔文件（其中的 `NR!=1` 表示不处理表头）。

```
netstat | awk 'NR!=1{print > $6}'

```

也可以把指定的列输出到文件：

```
netstat | awk 'NR!=1{print $4,$5 > $6}'

```

下面的命令计算所有的C文件，CPP文件和H文件的文件大小总和。

```
ls -l  *.cpp *.c *.h | awk '{sum+=$5} END {print sum}'

```

我们再来看一个统计各个 connection 状态的用法：（我们可以看到一些编程的影子了，大家都是程序员我就不解释了。注意其中的数组的用法）

```
netstat | awk 'NR!=1{a[$6]++;} END {for (i in a) print i ", " a[i];}'

```

再来看看统计每个用户的进程的占了多少内存：

```
ps aux | awk 'NR!=1{a[$1]+=$6;} END { for(i in a) print i ", " a[i]"KB";}'

```

从 file 文件中找出长度大于 80 的行：

```
awk 'length>80' file

```

按连接数查看客户端 IP：

```
netstat -ntu | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -nr

```

